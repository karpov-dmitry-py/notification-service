# notification-service

#### Сервис предназначен для выполнения рассылок клиентам уведомлений и управления/просмотра рассылками/клиентами/сообщениями.

Регистрация/авторизация не предусмотрена.
Отправка сообщений выполняется в удаленный сервис https://probe.fbrq.cloud/v1/send с применением полученного токена.

#### Функционал сервиса:

1. Управление рассылками (создание, обновление, просмотр, просмотр связанных сообщений, статистики по сообщениям
   рассылки, запуск, удаление)
2. Управление клиентами (создание, обновление, просмотр, удаление)
3. Автоматический запуск рассылок на отправку по расписанию (1 раз в минуту) с использованием Celery
4. Просмотр сообщений
5. Описание методов сервиса в формате OpenAPI (swagger + json/yml описание методов сервиса)

#### Предусмотрены инструменты мониторинга:

1. Веб-интерфейс отслеживания отправки сообщений Flower
2. Prometheus метрики (создание рассылки/клиента, отправка сообщения)
   1. notifications_total_created_total (в разрезе тега рассылки)
   2. customers_total_created_total (в разрезе тега клиента)
   3. messages_total_sent_total (в разрезе тега рассылки)
   4. messages_total_failed_total (в разрезе тега рассылки)
3. Логи сервиса (в консоли сервиса и в консоли воркеров Celery)

#### Методы сервиса:

1. Общее:
    1. `GET /health_check` - проверка работоспособности сервиса
    2. `GET /docs` - сваггер к сервису
    3. `GET /docs.json` - описание методов и сущностей сервиса в формате json
    4. `GET /docs.yaml` - описание методов и сущностей сервиса в формате yaml
    5. `GET /redoc` - redoc к сервису
    6. `GET /admin` - административный веб-интерфейс django
    7. `GET /api/v1/` - префикс к основному API сервиса


2. Рассылки:
    1. `GET /notification/` - получить список всех рассылок
    2. `GET /notification/all_stats/` - получить статистику по всем рассылкам (общее кол-во сообщений и детализация
       кол-ва сообщений по статусам)
    3. `GET /notification/int:pk/` - получить рассылку по id
    4. `GET /notification/int:pk/stats` - получить статистику по рассылке
    5. `GET /notification/int:pk/messages` - получить список сообщений по рассылке
    6. `GET /notification/int:pk/start` - запустить рассылку на выполнение
    7. `POST /notification/` - создать рассылку
    8. `PUT /notification/int:pk/` - обновить рассылку
    9. `DELETE /notification/int:pk/` - удалить рассылку (вместе со связанными сообщениями)


3. Клиенты:
    1. `GET /customer/` - получить список всех клиентов
    2. `GET /customer/int:pk/` - получить клиента по id
    3. `POST /customer/` - создать клиента
    4. `PUT /customer/int:pk/` - обновить клиента
    5. `DELETE /customer/int:pk/` - удалить клиента (вместе со связанными сообщениями)


4. Сообщения:
    1. `GET /message/` - получить список всех сообщений
    2. `GET /message/int:pk/` - получить сообщение по id

#### Запуск сервиса:

Сервис разработан на python 3.10.8.
После установки проекта сервис доступен на порту `:8000`

Инструмент мониторинга выполнения периодических/асинхронных задач Flower доступен по адресу `:5555/dashboard`

Для запуска сервиса требуется:

  1. Развернуть виртуальное окружение для проекта - `pip -m venv venv`
  2. Активировать виртуальное окружение для проекта - `source venv/bin/activate`
  3. В терминале виртуального окружения установить python-зависимости проекта - `pip install -r requirements.txt`
  4. Установить redis и запустить его на порту 6379 - для этого можно перейти в директорию с файлом `docker-compose.yml` 
и создать и запустить контейнер с редис командой `docker-compose up -d`
  5. Установить PostgreSQL и создать БД с указанными в настройках проекта именем БД и 
именем пользователя/паролем - см константу-словарь `DATABASES` в `settings.py` 
Аналогично редису можно создать и запустить контейнер с БД с помощью docker-compose, добавив узел-сервис для БД в файл. 
См пример на https://geshan.com.np/blog/2021/12/docker-postgres/#postgresql-with-docker-compose

  6. В терминале виртуального окружения выполнить последовательно команды: 
  ```
    python manage.py createsuperuser
    python manage.py makemigrations
    python manage.py migrate
    python manage.py runserver
  ```
  7. В терминале виртуального окружения (отдельная вкладка) запустить 
воркеров Celery командой `celery -A mailer  worker -l debug -B`
  8. В терминале виртуального окружения (отдельная вкладка) запустить 
веб-интерфейс Flower командой `celery -A mailer --broker=redis://127.0.0.1:6379 --result-backend=redis://127.0.0.1:6379 flower
` 

#### Выполненные доп. задания по задаче:

1. Сваггер
2. Логирование
3. Метрики


